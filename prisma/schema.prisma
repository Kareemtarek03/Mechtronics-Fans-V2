// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  firstName     String
  lastName      String
  phone         String?
  gender        String?
  role          String    @default("customer")
  password      String
  emailVerified Boolean   @default(false)
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  passwordResets PasswordReset[]
  adminLogs      AdminLog[]

  // Projects relations
  createdProjects        Project[]              @relation("CreatedProjects")
  customerProjects       Project[]              @relation("CustomerProjects")
  requestedProjectMotors ProjectMotor[]         @relation("RequestedProjectMotors")
  approvedProjectMotors  ProjectMotor[]         @relation("ApprovedProjectMotors")
  projectPermissions     ProjectUserPermission[]

  @@map("users")
}

model AdminLog {
  id          Int      @id @default(autoincrement())
  adminId     Int
  admin       User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  action      String
  targetUser  String?
  details     String?
  ipAddress   String?
  createdAt   DateTime @default(now())

  @@map("admin_logs")
}

model PasswordReset {
  id        Int     @id @default(autoincrement())
  userId    Int
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String  @unique
  expiresAt DateTime
  used      Boolean @default(false)
  createdAt DateTime @default(now())

  @@map("password_resets")
}
model FanData {
  id               Int       @id @default(autoincrement())
  No               Int?
  Model            String?
  AFS              Int?      @map("AF-S")
  AFL              Int?      @map("AF-L")
  WF               Int?
  ARTF             Int?
  SF               Int?
  ABSFC            Int?      @map("ABSF-C")
  ABSFS            Int?      @map("ABSF-S")
  SABF             Int?
  SARTF            Int?
  AJF              Int?
  bladesSymbol     String
  bladesMaterial   String
  noBlades         Int
  bladesAngle      Float
  hubType          Int
  impellerConf     String
  impellerInnerDia Float
  desigDensity     Float
  RPM              Float
  airFlow          Json
  totPressure      Json
  velPressure      Json
  staticPressure   Json
  fanInputPow      Json
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  projectMotors    ProjectMotor[]

  @@map("fan_data")
}

model MotorData {
  id             Int       @id @default(autoincrement())
  material       String?   // can be null
  model          String?   // can be null
  powerKW        Float?    // can be null
  speedRPM       Float?    // can be null
  NoPoles        Int?      // can be null
  rated          Json?     // can be null
  DOL            Json?     // can be null
  starDelta      Json?     // can be null
  powerFactor    Float?    // can be null
  Phase          Int?      // can be null
  frameSize      Int?      // can be null
  shaftDia       Float?    // can be null
  shaftLength    Float?    // can be null
  shaftFeather   Float?    // can be null
  IE             Int?      // can be null
  frontBear      String?   // can be null
  rearBear       String?   // can be null
  noiseLvl       Int?      // can be null
  weightKg       Float?    // can be null
  effCurve       Json?     // can be null
  NoCapacitors   Int?      // can be null
  NoPhases       Int?      // can be null
  insClass       String?   // can be null
  powerHorse     Float?    // can be null
  netpower       Float?    // can be null
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  projectMotors  ProjectMotor[]

  @@map("motor_data")
}

// =======================
// Projects Module Models
// =======================

enum ProjectStatus {
  ACTIVE
  ARCHIVED
}

enum ProjectMotorStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProjectMotorAction {
  ADD
  DELETE
}

enum ProjectPermissionRole {
  OWNER
  COLLABORATOR
  VIEWER
}

model Project {
  id          Int            @id @default(autoincrement())
  name        String
  description String?
  status      ProjectStatus  @default(ACTIVE)

  // Who created the project (engineer / supervisor / customer)
  creatorId   Int
  creator     User           @relation("CreatedProjects", fields: [creatorId], references: [id], onDelete: Cascade)

  // If a customer owns the project (for visibility rules)
  customerId  Int?
  customer    User?          @relation("CustomerProjects", fields: [customerId], references: [id], onDelete: SetNull)

  // History of fan+motor operations associated with this project
  motors      ProjectMotor[]

  // Optional per-user permissions
  permissions ProjectUserPermission[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Unique project name per creator (engineer/supervisor/customer)
  @@unique([creatorId, name])

  @@map("projects")
}

model ProjectMotor {
  id            Int                @id @default(autoincrement())

  projectId     Int
  project       Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Link to existing fan and motor data
  fanId         Int
  fan           FanData            @relation(fields: [fanId], references: [id], onDelete: Cascade)

  motorId       Int
  motor         MotorData          @relation(fields: [motorId], references: [id], onDelete: Cascade)

  action        ProjectMotorAction
  status        ProjectMotorStatus @default(PENDING)

  // Indicates if this record currently represents an active fan+motor pair
  isActive      Boolean            @default(false)

  // Who requested the change
  requestedById Int
  requestedBy   User               @relation("RequestedProjectMotors", fields: [requestedById], references: [id], onDelete: Cascade)

  // Who approved/rejected the update (supervisor only)
  approvedById  Int?
  approvedBy    User?              @relation("ApprovedProjectMotors", fields: [approvedById], references: [id], onDelete: SetNull)

  comment       String?

  requestedAt   DateTime           @default(now())
  decidedAt     DateTime?

  @@index([projectId])
  @@index([status])

  @@map("project_motors")
}

model ProjectUserPermission {
  id          Int                   @id @default(autoincrement())

  projectId   Int
  project     Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId      Int
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        ProjectPermissionRole
  canEditMeta Boolean               @default(false)

  @@unique([projectId, userId])

  @@map("project_user_permissions")
}

